<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>Wyb√≥r logotypu firmy</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; width: 100%; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0f172a;
      color: #f9fafb;
      display: flex;
      flex-direction: column;
    }

    header {
      padding: 8px 16px;
      background: #020617;
      box-shadow: 0 2px 6px rgba(0,0,0,0.4);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 8px;
      z-index: 10;
    }

    .header-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    header h1 { font-size: 1.3rem; margin: 0; }
    header p { font-size: 0.85rem; opacity: 0.9; }

    #progress { color: #38bdf8; font-weight: 600; }

    #restartBtn {
      border: none;
      border-radius: 999px;
      padding: 6px 14px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      background: #f97316;
      color: #111827;
      transition: 0.2s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.4);
      white-space: nowrap;
    }

    #restartBtn:hover {
      transform: scale(1.05);
      filter: brightness(1.05);
    }

    .grid-wrapper {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 4px;
      min-height: 0;
    }

    #grid {
      width: 100%;
      height: 100%;
      display: grid;
      gap: 6px;
    }

    .logo-card {
      background: #0b1120;
      border-radius: 12px;
      overflow: hidden;
      border: 2px solid #1e293b;
      cursor: pointer;
      box-shadow: 0 3px 16px rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .logo-card:hover {
      transform: scale(1.03);
      border-color: #38bdf8;
      box-shadow: 0 4px 24px rgba(0,0,0,0.8);
    }

    .logo-card img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      object-position: center;
      background: #020617;
    }

    #results {
      padding: 16px;
      background: #020617;
      border-top: 1px solid #1f2937;
    }

    #ranking p {
      margin-bottom: 4px;
      font-size: 0.95rem;
    }

    #ranking img {
      vertical-align: middle;
      margin-left: 8px;
      border-radius: 6px;
      background: #0b1120;
      max-height: 80px;
    }

    #status {
      font-size: 0.8rem;
      opacity: 0.85;
      margin-top: 6px;
      padding: 6px 10px;
      border-radius: 6px;
      background: #111827;
      white-space: pre-line;
    }

    #endpointInfo {
      font-size: 0.7rem;
      opacity: 0.7;
      margin-top: 2px;
    }

    @media (max-width: 800px) {
      header h1 { font-size: 1.1rem; }
      header p { font-size: 0.8rem; }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-text">
      <h1>Wyb√≥r logotypu firmy</h1>
      <p id="instructions">Etap 1 z 3: wybierz najlepszy logotyp spo≈õr√≥d 4. (Zestaw 1 z 48)</p>
      <p id="progress">Pozosta≈Ço klikniƒôƒá: 72</p>
      <p id="endpointInfo"></p>
    </div>
    <button id="restartBtn">üîÅ Zacznij od poczƒÖtku</button>
  </header>

  <div class="grid-wrapper">
    <div id="grid"></div>
  </div>

  <div id="results">
    <div id="ranking"></div>
    <div id="status"></div>
  </div>

  <script>
    // üîß TUTAJ WKLEJASZ URL Z APPS SCRIPT:
    const ENDPOINT_URL = 'https://script.google.com/macros/s/AKfycbxjceZCcOlnR2ojKd78YZaWVUGO4akZyPJbVajfo1H6czaUFWnOYP7Pw3weAdsYez-Q/exec';

    const IMAGE_COUNT = 192;
    const TOTAL_CLICKS = 48 + 12 + 12;

    const MASTER_LOGOS = Array.from(
      { length: IMAGE_COUNT },
      (_, i) => `logos/logo (${i + 1}).png`
    );

    let allLogos = [];
    let stage = 1;
    let round = 0;

    let winners48 = [];
    let stage2Groups = [];
    let winners12 = [];

    let remaining12 = [];
    let ranking = [];

    let clickCount = 0;
    let sessionId = '';

    const grid = document.getElementById('grid');
    const instructionsEl = document.getElementById('instructions');
    const progressEl = document.getElementById('progress');
    const rankingEl = document.getElementById('ranking');
    const statusEl = document.getElementById('status');
    const endpointInfoEl = document.getElementById('endpointInfo');

    function debug(msg) {
      statusEl.textContent = msg;
    }

    function showEndpointInfo() {
      if (!ENDPOINT_URL) {
        endpointInfoEl.textContent = 'ENDPOINT_URL: (pusty ‚Äì wyniki nie bƒôdƒÖ wysy≈Çane)';
      } else {
        const short = ENDPOINT_URL.length > 60
          ? ENDPOINT_URL.slice(0, 60) + '...'
          : ENDPOINT_URL;
        endpointInfoEl.textContent = 'ENDPOINT_URL: ' + short;
      }
    }

    function shuffle(array) {
      return array
        .map(v => ({ v, sort: Math.random() }))
        .sort((a, b) => a.sort - b.sort)
        .map(({ v }) => v);
    }

    function setInstructions(text) {
      instructionsEl.textContent = text;
    }

    function updateProgress() {
      const remaining = TOTAL_CLICKS - clickCount;
      progressEl.textContent = `Pozosta≈Ço klikniƒôƒá: ${remaining}`;
    }

    function setGridLayoutForCount(count) {
      if (count <= 4) {
        grid.style.gridTemplateColumns = 'repeat(2, 1fr)';
        grid.style.gridTemplateRows = 'repeat(2, 1fr)';
      } else {
        grid.style.gridTemplateColumns = 'repeat(4, 1fr)';
        grid.style.gridTemplateRows = 'repeat(3, 1fr)';
      }
    }

    function renderGroup(group, onChoose) {
      setGridLayoutForCount(group.length);
      grid.innerHTML = '';
      group.forEach(src => {
        const card = document.createElement('div');
        card.className = 'logo-card';
        const img = document.createElement('img');
        img.src = src;
        img.alt = '';
        card.appendChild(img);
        card.onclick = () => onChoose(src);
        grid.appendChild(card);
      });
    }

    // --- Wysy≈Çanie wynik√≥w do Google Apps Script ---
    async function sendResultsToServer() {
      if (!ENDPOINT_URL || ENDPOINT_URL === 'https://script.google.com/macros/s/AKfycbxjceZCcOlnR2ojKd78YZaWVUGO4akZyPJbVajfo1H6czaUFWnOYP7Pw3weAdsYez-Q/exec') {
        debug('Wyniki zapisane lokalnie.\n(Ustaw ENDPOINT_URL, aby wysy≈Çaƒá je do arkusza Google.)');
        return;
      }
      if (!ENDPOINT_URL.startsWith('https://script.google.com/macros/s/')) {
        debug('ENDPOINT_URL nie wyglƒÖda na adres Google Apps Script.\nSprawd≈∫, czy wklei≈Çe≈õ poprawny URL Web Appa (ko≈ÑczƒÖcy siƒô na /exec).');
        return;
      }

      const payload = { sessionId, ranking, clickCount };

      debug('üì§ Wysy≈Çanie wynik√≥w...\n(Je≈õli co≈õ p√≥jdzie nie tak, poka≈ºƒô kod b≈Çƒôdu tutaj.)');

      try {
        const res = await fetch(ENDPOINT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const text = await res.text();
        if (!res.ok) {
          debug('‚ö† B≈ÇƒÖd HTTP przy wysy≈Çaniu wynik√≥w.\nStatus: ' + res.status + '\nOdpowied≈∫:\n' + text.slice(0, 300));
          return;
        }

        debug('‚úÖ Wyniki zosta≈Çy wys≈Çane.\nOdpowied≈∫ serwera:\n' + text.slice(0, 300));
      } catch (err) {
        debug('‚ö† B≈ÇƒÖd sieci podczas wysy≈Çania wynik√≥w:\n' + err);
      }
    }

    // --- ETAP 1: 192 ‚Üí 48 ---
    function nextStage1() {
      if (round >= 48) {
        startStage2();
        return;
      }

      setInstructions(`Etap 1 z 3: wybierz najlepszy logotyp spo≈õr√≥d 4. (Zestaw ${round + 1} z 48)`);

      const group = allLogos.slice(round * 4, round * 4 + 4);
      renderGroup(group, (chosen) => {
        winners48.push(chosen);
        clickCount++;
        updateProgress();
        round++;
        nextStage1();
      });
    }

    // --- ETAP 2: 48 ‚Üí 12 (12 grup po 4, bez powt√≥rek) ---
    function startStage2() {
      stage = 2;
      round = 0;
      winners12 = [];

      const shuffled48 = shuffle(winners48.slice());
      stage2Groups = [];
      for (let i = 0; i < shuffled48.length; i += 4) {
        stage2Groups.push(shuffled48.slice(i, i + 4));
      }

      nextStage2();
    }

    function nextStage2() {
      if (round >= stage2Groups.length) {
        startStage3();
        return;
      }

      const group = stage2Groups[round];
      setInstructions(`Etap 2 z 3: wybierz najlepszy logotyp spo≈õr√≥d 4. (Runda ${round + 1} z 12)`);

      renderGroup(group, (chosen) => {
        winners12.push(chosen);
        clickCount++;
        updateProgress();
        round++;
        nextStage2();
      });
    }

    // --- ETAP 3: pe≈Çny ranking 1‚Äì12, klikniƒôte logo znika ---
    function startStage3() {
      stage = 3;
      ranking = [];
      remaining12 = shuffle(winners12.slice());
      renderStage3Step();
    }

    function renderStage3Step() {
      if (remaining12.length === 0) {
        showResults();
        return;
      }

      const place = ranking.length + 1;
      setInstructions(
        `Etap 3 z 3: wybierz logotyp na miejsce ${place} (z ${place <= 12 ? 12 : ''}). ` +
        `Po klikniƒôciu grafika znika z ekranu.`
      );

      renderGroup(remaining12, (chosen) => {
        ranking.push(chosen);
        clickCount++;
        updateProgress();

        const idx = remaining12.indexOf(chosen);
        if (idx !== -1) remaining12.splice(idx, 1);

        renderStage3Step();
      });
    }

    function showResults() {
      grid.innerHTML = '';
      setInstructions('Wynik ko≈Ñcowy ‚Äì Tw√≥j ranking 12 logotyp√≥w (od 1 do 12 miejsca):');
      updateProgress();

      rankingEl.innerHTML = ranking
        .map((src, i) => `<p><strong>Miejsce ${i + 1}:</strong> ${src} <img src="${src}" /></p>`)
        .join('');

      sendResultsToServer();
    }

    function restartAll() {
      stage = 1;
      round = 0;
      winners48 = [];
      stage2Groups = [];
      winners12 = [];
      remaining12 = [];
      ranking = [];
      clickCount = 0;
      statusEl.textContent = '';
      rankingEl.innerHTML = '';

      sessionId = 'sess-' + Date.now() + '-' + Math.random().toString(36).slice(2);

      allLogos = shuffle(MASTER_LOGOS.slice());

      setInstructions('Etap 1 z 3: wybierz najlepszy logotyp spo≈õr√≥d 4. (Zestaw 1 z 48)');
      updateProgress();
      nextStage1();
    }

    document.getElementById('restartBtn').onclick = restartAll;

    showEndpointInfo();
    restartAll();
  </script>
</body>
</html>
