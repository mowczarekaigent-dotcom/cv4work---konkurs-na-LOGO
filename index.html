<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>Wyb√≥r logotypu firmy ‚Äî v11</title>
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; width: 100%; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0f172a;
      color: #f9fafb;
      display: flex;
      flex-direction: column;
    }
    header {
      padding: 8px 16px;
      background: #020617;
      box-shadow: 0 2px 6px rgba(0,0,0,0.4);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 8px;
      z-index: 10;
    }
    header h1 { font-size: 1.3rem; margin: 0; }
    header p { font-size: 0.85rem; opacity: 0.9; }
    #progress { color: #38bdf8; font-weight: 600; }
    #restartBtn {
      border: none;
      border-radius: 999px;
      padding: 6px 14px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      background: #f97316;
      color: #111827;
      transition: 0.2s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.4);
    }
    #restartBtn:hover { transform: scale(1.05); filter: brightness(1.05); }
    .grid-wrapper {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 4px;
      min-height: 0;
    }
    #grid { width: 100%; height: 100%; display: grid; gap: 6px; }
    .logo-card {
      background: #0b1120;
      border-radius: 12px;
      overflow: hidden;
      border: 2px solid #1e293b;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }
    .logo-card:hover {
      transform: scale(1.03);
      border-color: #38bdf8;
    }
    .logo-card img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      object-position: center;
      background: #020617;
    }
    #results {
      padding: 16px;
      background: #020617;
      border-top: 1px solid #1f2937;
    }
    #ranking p { margin-bottom: 4px; font-size: 0.95rem; }
    #ranking img {
      vertical-align: middle;
      margin-left: 8px;
      border-radius: 6px;
      background: #0b1120;
      max-height: 80px;
    }
    #status {
      font-size: 0.8rem;
      opacity: 0.85;
      margin-top: 6px;
      padding: 6px 10px;
      border-radius: 6px;
      background: #111827;
      white-space: pre-line;
    }
    @media (max-width: 800px) {
      header h1 { font-size: 1.1rem; }
      header p { font-size: 0.8rem; }
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Wyb√≥r logotypu firmy</h1>
      <p id="instructions">Etap 1 z 3: wybierz najlepszy logotyp spo≈õr√≥d 4. (Zestaw 1 z 48)</p>
      <p id="progress">Pozosta≈Ço klikniƒôƒá: 72</p>
      <p id="endpointInfo" style="font-size: 0.7rem; opacity: 0.7;"></p>
    </div>
    <button id="restartBtn">üîÅ Zacznij od poczƒÖtku</button>
  </header>

  <div class="grid-wrapper">
    <div id="grid"></div>
  </div>

  <div id="results">
    <div id="ranking"></div>
    <div id="status"></div>
  </div>

  <script>
    // üîß Tw√≥j endpoint Google Apps Script:
    const ENDPOINT_URL = 'https://script.google.com/macros/s/AKfycbxjceZCcOlnR2ojKd78YZaWVUGO4akZyPJbVajfo1H6czaUFWnOYP7Pw3weAdsYez-Q/exec';

    // konfiguracja obrazk√≥w
    const REPO = 'cv4work---konkurs-na-LOGO';
    const ASSET_BASE = `/${REPO}/logos/`;
    const IMAGE_COUNT = 192;
    const TOTAL_CLICKS = 48 + 12 + 12;

    const MASTER_LOGOS = Array.from({ length: IMAGE_COUNT }, (_, i) =>
      ASSET_BASE + encodeURIComponent(`logo (${i + 1}).png`)
    );

    let allLogos = [];
    let stage = 1, round = 0, clickCount = 0;
    let winners48 = [], winners12 = [], ranking = [], remaining12 = [];
    let sessionId = '';

    const grid = document.getElementById('grid');
    const instructionsEl = document.getElementById('instructions');
    const progressEl = document.getElementById('progress');
    const rankingEl = document.getElementById('ranking');
    const statusEl = document.getElementById('status');
    const endpointInfoEl = document.getElementById('endpointInfo');

    function debug(msg){ statusEl.textContent = msg; }
    function shuffle(a){ return a.map(v=>({v,sort:Math.random()})).sort((a,b)=>a.sort-b.sort).map(x=>x.v); }
    function updateProgress(){ progressEl.textContent = `Pozosta≈Ço klikniƒôƒá: ${TOTAL_CLICKS - clickCount}`; }
    function setInstructions(t){ instructionsEl.textContent = t; }
    function setGridLayout(c){ grid.style.gridTemplateColumns = c<=4?'repeat(2,1fr)':'repeat(4,1fr)'; grid.style.gridTemplateRows = c<=4?'repeat(2,1fr)':'repeat(3,1fr)'; }

    function renderGroup(group, onChoose){
      setGridLayout(group.length);
      grid.innerHTML = '';
      group.forEach(src=>{
        const d=document.createElement('div');
        d.className='logo-card';
        const i=document.createElement('img');
        i.src=src; d.appendChild(i);
        d.onclick=()=>onChoose(src);
        grid.appendChild(d);
      });
    }

    async function sendResultsToServer(){
      if(!ENDPOINT_URL){
        debug('Brak ENDPOINT_URL w kodzie.');
        return;
      }
      const payload={sessionId, ranking, clickCount};
      debug('üì§ Wysy≈Çanie wynik√≥w...');
      try{
        const res=await fetch(ENDPOINT_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
        const text=await res.text();
        if(!res.ok){debug('‚ö† B≈ÇƒÖd HTTP: '+res.status+'\n'+text);return;}
        debug('‚úÖ Wyniki wys≈Çane. Odpowied≈∫: '+text);
      }catch(e){debug('‚ö† B≈ÇƒÖd sieci: '+e);}
    }

    function nextStage1(){
      if(round>=48){ startStage2(); return; }
      setInstructions(`Etap 1 z 3: wybierz najlepszy logotyp spo≈õr√≥d 4. (Zestaw ${round+1} z 48)`);
      const group=allLogos.slice(round*4,round*4+4);
      renderGroup(group,chosen=>{
        winners48.push(chosen);
        clickCount++; updateProgress(); round++; nextStage1();
      });
    }

    function startStage2(){
      stage=2; round=0; winners12=[];
      const shuffled=shuffle(winners48);
      const groups=[]; for(let i=0;i<shuffled.length;i+=4) groups.push(shuffled.slice(i,i+4));
      nextStage2(groups);
    }

    function nextStage2(groups){
      if(round>=groups.length){ startStage3(); return; }
      const group=groups[round];
      setInstructions(`Etap 2 z 3: wybierz najlepszy logotyp spo≈õr√≥d 4. (Runda ${round+1} z 12)`);
      renderGroup(group,chosen=>{
        winners12.push(chosen);
        clickCount++; updateProgress(); round++; nextStage2(groups);
      });
    }

    function startStage3(){
      stage=3; ranking=[]; remaining12=shuffle(winners12);
      renderStage3Step();
    }

    function renderStage3Step(){
      if(remaining12.length===0){ showResults(); return; }
      const place=ranking.length+1;
      setInstructions(`Etap 3 z 3: wybierz logotyp na miejsce ${place} z 12.`);
      renderGroup(remaining12,chosen=>{
        ranking.push(chosen);
        clickCount++; updateProgress();
        remaining12=remaining12.filter(x=>x!==chosen);
        renderStage3Step();
      });
    }

    function showResults(){
      grid.innerHTML=''; setInstructions('Tw√≥j ranking 12 logotyp√≥w:');
      rankingEl.innerHTML=ranking.map((src,i)=>`<p><strong>${i+1}.</strong> <img src="${src}" height="60"></p>`).join('');
      sendResultsToServer();
    }

    function restartAll(){
      stage=1; round=0; clickCount=0; winners48=[]; winners12=[]; ranking=[]; remaining12=[];
      sessionId='sess-'+Date.now();
      allLogos=shuffle(MASTER_LOGOS.slice());
      updateProgress();
      setInstructions('Etap 1 z 3: wybierz najlepszy logotyp spo≈õr√≥d 4. (Zestaw 1 z 48)');
      nextStage1();
    }

    document.getElementById('restartBtn').onclick=restartAll;
    endpointInfoEl.textContent='ENDPOINT_URL: '+ENDPOINT_URL;
    restartAll();
  </script>
</body>
</html>
